<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Safety Spot</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@400;500;700&display=swap" rel="stylesheet">
    
    <style>
        body { 
            font-family: 'Kanit', sans-serif; 
            background-color: #f0f2f5; 
        }
        #main-app, #registration-page { 
            display: none; 
        }
        .page { 
            display: none; 
        }
        .page.active { 
            display: block; 
        }
        .bottom-nav { 
            box-shadow: 0 -2px 10px rgba(0,0,0,0.08); 
        }
        .nav-link { 
            color: #6c757d; 
        }
        .nav-link.active { 
            color: #0d6efd; 
            font-weight: 500;
        }
        #admin-nav-item { 
            color: #dc3545; 
        }
        #admin-nav-item.active { 
            color: #a1232e; 
        }
        .badge-icon { 
            width: 60px; 
            height: 60px; 
        }
        .badge-icon.locked { 
            filter: grayscale(100%); 
            opacity: 0.5; 
        }
        .leaderboard-rank { 
            font-size: 1.2rem; 
            font-weight: bold; 
            min-width: 40px; 
            text-align: center; 
        }
        .leaderboard-item .fa-trophy { 
            color: #ffc107; 
        }
        .table-responsive { 
            max-height: 75vh; 
        }
        .submission-card { 
            background-color: #fff; 
            border: 1px solid #dee2e6;
            border-radius: 0.75rem;
        }
        .like-btn .fa-heart { 
            transition: color 0.2s, transform 0.2s; 
        }
        .like-btn.liked .fa-heart { 
            color: #dc3545; 
            transform: scale(1.2); 
        }
        .comment-list { 
            max-height: 200px; 
            overflow-y: auto; 
        }
        .comment-item { 
            background-color: #f8f9fa; 
            font-size: 0.9rem; 
        }
        .stat-card { 
            border-left: 5px solid #0d6efd; 
        }
        .image-preview-container {
            width: 100%;
            padding-top: 56.25%; /* 16:9 Aspect Ratio */
            position: relative;
            background-color: #e9ecef;
            border-radius: 0.5rem;
            overflow: hidden;
            margin-bottom: 1rem;
        }
        .image-preview {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        /* Styles for Admin tabs */
        .admin-tab-btn.active {
            border-bottom: 2px solid #0d6efd;
            font-weight: bold;
        }

        /* Styles for new UI */
        .btn-view-report, .btn-join-activity {
            width: calc(50% - 0.25rem); /* Adjusted for spacing */
        }
    </style>
</head>
<body>

    <div id="registration-page" class="container py-4">
        <div class="card shadow-sm border-0">
            <div class="card-body p-4">
                <h4 class="card-title text-center fw-bold mb-1">‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</h4>
                <p class="text-center text-muted mb-4">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</p>
                <form id="registration-form">
                    <div class="mb-3">
                        <label for="fullName" class="form-label">‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</label>
                        <input type="text" class="form-control" id="fullName" required placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏™‡∏°‡∏ä‡∏≤‡∏¢ ‡πÉ‡∏à‡∏î‡∏µ">
                    </div>
                    <div class="mb-3">
                        <label for="employeeId" class="form-label">‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</label>
                        <input type="text" class="form-control" id="employeeId" required placeholder="‡πÄ‡∏ä‡πà‡∏ô 12345">
                    </div>
                    <button type="submit" class="btn btn-primary w-100 fw-bold mt-3 py-2">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÅ‡∏•‡∏∞‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</button>
                </form>
            </div>
        </div>
    </div>

    <div id="main-app">
        <main class="container py-3 pb-5 mb-5">
            <div id="home-page" class="page active">
                 <div class="d-flex align-items-center p-3 mb-4 bg-white rounded-3 shadow-sm">
                    <img id="user-profile-pic" src="https://placehold.co/60x60" class="rounded-circle me-3" width="60" height="60" alt="Profile Picture">
                    <div>
                        <p class="mb-0 text-muted small" id="user-employee-id">‡∏£‡∏´‡∏±‡∏™: ...</p>
                        <h5 class="mb-0 fw-bold" id="user-display-name">...</h5>
                    </div>
                    <div class="ms-auto text-end">
                        <div class="fw-bold text-primary">
                            <h4 class="mb-0" id="user-score">0</h4>
                            <small>‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</small>
                        </div>
                    </div>
                </div>
                <h5 class="mb-3">‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</h5>
                <div id="latest-activities-list">
                    <p class="text-center text-muted">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°...</p>
                </div>
            </div>
            <div id="activities-page" class="page">
                <h4 class="mb-3 fw-bold">‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h4>
                <div id="all-activities-list"></div>
            </div>
            <div id="leaderboard-page" class="page">
                <h4 class="mb-3 fw-bold">‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏ô‡∏ú‡∏π‡πâ‡∏ô‡∏≥</h4>
                <div id="leaderboard-list"></div>
                <div id="leaderboard-loading" class="text-center my-5">
                    <div class="spinner-border" role="status"></div>
                </div>
            </div>
            <div id="profile-page" class="page">
                 <div class="card shadow-sm border-0">
                    <div class="card-body text-center p-4">
                        <img id="profile-page-pic" src="https://placehold.co/80x80" class="rounded-circle mb-3 border border-3 border-primary" width="80" height="80" alt="Profile Picture">
                        <h4 id="profile-page-name" class="fw-bold">...</h4>
                        <p class="text-muted" id="profile-page-employee-id">‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô: ...</p>
                        <p class="text-muted mb-4">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏™‡∏∞‡∏™‡∏°: <span class="fw-bold text-primary" id="profile-page-score">0</span></p>
                        
                        <div class="mt-4 mb-3 text-start">
                            <h6 class="fw-bold">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏∑‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏™‡∏π‡πà‡∏õ‡πâ‡∏≤‡∏¢‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡∏ñ‡∏±‡∏î‡πÑ‡∏õ</h6>
                            <div class="progress" style="height: 20px;">
                                <div id="progress-bar" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0%</div>
                            </div>
                            <small class="text-muted" id="progress-text"></small>
                        </div>

                        <hr>
                        <h5 class="mt-4 mb-3">‡∏õ‡πâ‡∏≤‡∏¢‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô</h5>
                        <div id="badges-container" class="d-flex justify-content-center flex-wrap gap-3"></div>
                    </div>
                </div>
            </div>
            <div id="admin-page" class="page">
                <h4 class="fw-bold mb-3">Admin Panel</h4>
                <div class="list-group">
                    <a href="#" id="view-stats-btn" class="list-group-item list-group-item-action"><i class="fas fa-chart-line me-2"></i> ‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏£‡∏∏‡∏õ (Dashboard)</a>
                    <a href="#" id="manage-reports-btn" class="list-group-item list-group-item-action"><i class="fas fa-inbox me-2"></i> ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤</a>
                    <a href="#" id="manage-activities-btn" class="list-group-item list-group-item-action"><i class="fas fa-tasks me-2"></i> ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</a>
                    <a href="#" id="manage-badges-btn" class="list-group-item list-group-item-action"><i class="fas fa-certificate me-2"></i> ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÅ‡∏•‡∏∞‡∏õ‡πâ‡∏≤‡∏¢‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•</a>
                </div>
            </div>
        </main>
        
        <nav class="navbar navbar-light bg-white fixed-bottom bottom-nav">
            <div class="container-fluid d-flex justify-content-around">
                <a href="#home" class="nav-link active text-center" data-page="home-page"><i class="fas fa-home fs-4"></i><div style="font-size:0.7rem;">‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</div></a>
                <a href="#activities" class="nav-link text-center" data-page="activities-page"><i class="fas fa-tasks fs-4"></i><div style="font-size:0.7rem;">‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</div></a>
                <a href="#admin" class="nav-link text-center" data-page="admin-page" id="admin-nav-item" style="display:none;"><i class="fas fa-user-shield fs-4"></i><div style="font-size:0.7rem;">Admin</div></a>
                <a href="#leaderboard" class="nav-link text-center" data-page="leaderboard-page"><i class="fas fa-trophy fs-4"></i><div style="font-size:0.7rem;">‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö</div></a>
                <a href="#profile" class="nav-link text-center" data-page="profile-page"><i class="fas fa-user fs-4"></i><div style="font-size:0.7rem;">‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå</div></a>
            </div>
        </nav>
    </div>
    
    <div class="modal fade" id="submission-modal" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><form id="submission-form"><input type="hidden" id="activityId-input"><h5 id="activity-title-modal" class="fw-bold mb-3"></h5><div class="mb-3"><label class="form-label">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏à‡∏∏‡∏î‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á</label><textarea class="form-control" id="description-input" rows="4" required></textarea></div><div class="mb-3"><label class="form-label">‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û</label><input type="file" class="form-control" id="image-input" accept="image/*"></div><div class="image-preview-container"><img id="submission-image-preview" src="https://placehold.co/400x300/e9ecef/6c757d?text=Preview" class="image-preview"></div><button type="submit" class="btn btn-primary w-100 fw-bold mt-3 py-2">‡∏™‡πà‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</button></form></div></div></div></div>
    <div class="modal fade" id="admin-reports-modal" tabindex="-1"><div class="modal-dialog modal-fullscreen"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô (<span id="pending-count-modal">0</span>)</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="table-responsive"><table class="table table-striped table-hover mb-0"><thead class="table-dark"><tr><th>‡∏ú‡∏π‡πâ‡∏™‡πà‡∏á</th><th>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</th><th>‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û</th><th>Actions</th></tr></thead><tbody id="submissions-table-body"></tbody></table></div><div id="reports-loading" class="text-center my-4"><div class="spinner-border"></div></div><div id="no-reports-message" class="text-center my-4" style="display:none;"><p class="text-muted">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö</p></div></div></div></div></div>
    <div class="modal fade" id="admin-activities-modal" tabindex="-1"><div class="modal-dialog modal-fullscreen"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><button id="create-activity-btn" class="btn btn-success mb-3"><i class="fas fa-plus"></i> ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡πÉ‡∏´‡∏°‡πà</button><div id="activities-list-admin"></div></div></div></div></div>
    <div class="modal fade" id="activity-form-modal" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="activity-form-title">‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡πÉ‡∏´‡∏°‡πà</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><form id="activity-form"><input type="hidden" id="form-activity-id"><div class="mb-3"><label class="form-label">‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠</label><input type="text" class="form-control" id="form-activity-title" required></div><div class="mb-3"><label class="form-label">‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢</label><textarea class="form-control" id="form-activity-desc" rows="3" required></textarea></div><div class="mb-3"><label class="form-label">‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</label><input type="file" class="form-control" id="form-activity-image-input" accept="image/*"><div class="image-preview-container mt-2"><img id="activity-image-preview" src="https://placehold.co/400x300/e9ecef/6c757d?text=Preview" class="image-preview"></div><input type="hidden" id="form-activity-image-url"></div><button type="submit" class="btn btn-primary w-100">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button></form></div></div></div></div>
    <div class="modal fade" id="activity-detail-modal" tabindex="-1">
        <div class="modal-dialog modal-fullscreen">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="activity-detail-title">...</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body bg-light">
                    <div id="submissions-container" class="container-fluid"></div>
                    <div id="submissions-loading" class="text-center my-5"><div class="spinner-border"></div></div>
                </div>
                <div class="modal-footer d-flex justify-content-between">
                    <button type="button" class="btn btn-outline-primary fw-bold py-2 me-1 btn-view-report" data-bs-dismiss="modal"><i class="fas fa-eye me-1"></i> ‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</button>
                    <button type="button" class="btn btn-primary fw-bold py-2 ms-1 btn-join-activity" data-bs-dismiss="modal"><i class="fas fa-plus-circle me-1"></i> ‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°</button>
                </div>
            </div>
        </div>
    </div>
    <div class="modal fade" id="admin-stats-modal" tabindex="-1"><div class="modal-dialog modal-dialog-centered modal-lg"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏£‡∏∏‡∏õ Dashboard</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="row g-3"><div class="col-12"><canvas id="reportsChart"></canvas></div></div><div id="stats-container" class="row g-3 mt-3"></div><div id="stats-loading" class="text-center my-4"><div class="spinner-border"></div></div></div></div></div></div>

    <div class="modal fade" id="admin-manage-badges-modal" tabindex="-1">
        <div class="modal-dialog modal-fullscreen">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÅ‡∏•‡∏∞‡∏õ‡πâ‡∏≤‡∏¢‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <ul class="nav nav-tabs mb-4">
                        <li class="nav-item">
                            <a class="nav-link active admin-tab-btn" data-tab="manageBadges" href="#">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏õ‡πâ‡∏≤‡∏¢‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link admin-tab-btn" data-tab="manageUsers" href="#">‡∏°‡∏≠‡∏ö‡∏õ‡πâ‡∏≤‡∏¢‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡πÉ‡∏´‡πâ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</a>
                        </li>
                    </ul>
                    <div id="manageBadgesTab" class="admin-tab-content active">
                        <button id="add-badge-btn" class="btn btn-success mb-3"><i class="fas fa-plus"></i> ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏õ‡πâ‡∏≤‡∏¢‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡πÉ‡∏´‡∏°‡πà</button>
                        <div id="badges-list" class="row"></div>
                    </div>
                    <div id="manageUsersTab" class="admin-tab-content" style="display:none;">
                        <div class="mb-3">
                            <input type="text" id="user-search-input" class="form-control" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏î‡πâ‡∏ß‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô...">
                        </div>
                        <div id="user-search-results"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="modal fade" id="badge-form-modal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="badge-form-title">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏õ‡πâ‡∏≤‡∏¢‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡πÉ‡∏´‡∏°‡πà</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="badge-form">
                        <input type="hidden" id="badge-id-input">
                        <div class="mb-3">
                            <label class="form-label">‡∏ä‡∏∑‡πà‡∏≠‡∏õ‡πâ‡∏≤‡∏¢‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•</label>
                            <input type="text" class="form-control" id="badge-name-input" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢</label>
                            <textarea class="form-control" id="badge-desc-input" rows="3" required></textarea>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏õ‡πâ‡∏≤‡∏¢‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•</label>
                            <input type="file" class="form-control" id="badge-image-input" accept="image/*" required>
                            <div class="image-preview-container mt-2">
                                <img id="badge-image-preview" src="https://placehold.co/400x300/e9ecef/6c757d?text=Preview" class="image-preview">
                            </div>
                            <input type="hidden" id="badge-image-url-input">
                        </div>
                        
                        <button type="submit" class="btn btn-primary w-100">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script src="//cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <script>
        // ===============================================================
        //  APP CONFIGURATION
        // ===============================================================
        const API_BASE_URL = "https://shesafety-spot-appbackend.onrender.com";
        const LIFF_ID = "2007053300-9xLKdwZp";
        
        // Global variables
        let lineProfile = {}; 
        let allModals = {};
        let currentUser = {};
        let reportsChart;

        // ===============================================================
        //  INITIALIZATION
        // ===============================================================
        $(document).ready(function() {
            initializeAllModals();
            initializeApp();
            bindStaticEventListeners();
            bindAdminTabEventListeners();
        });

        function initializeAllModals() {
            const modalIds = ['submission', 'admin-reports', 'admin-activities', 'activity-form', 'activity-detail', 'admin-stats', 'admin-manage-badges', 'badge-form'];
            modalIds.forEach(id => {
                allModals[id] = new bootstrap.Modal(document.getElementById(`${id}-modal`));
            });
        }

        async function initializeApp() {
            try {
                showLoading('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô...');
                await liff.init({ liffId: LIFF_ID });

                if (!liff.isLoggedIn()) {
                    liff.login();
                    return;
                }

                lineProfile = await liff.getProfile();
                const result = await callApi('/api/user/profile', { lineUserId: lineProfile.userId });
                
                if (result.registered) {
                    await showMainApp(result.user);
                } else {
                    $('#registration-page').fadeIn();
                    Swal.close();
                }
            } catch (error) {
                console.error("Initialization failed:", error);
                showError('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÅ‡∏≠‡∏õ‡∏û‡∏•‡∏¥‡πÄ‡∏Ñ‡∏ä‡∏±‡∏ô‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á');
            }
        }
        
        async function showMainApp(userData) {
            currentUser = userData;
            updateUserInfoUI(currentUser);
            
            if (currentUser.isAdmin) {
                $('#admin-nav-item').show();
                bindAdminEventListeners();
            }

            const activities = await callApi('/api/activities');
            displayActivitiesUI(activities, 'latest-activities-list');
            displayActivitiesUI(activities, 'all-activities-list');
            
            $('#main-app').fadeIn();
            Swal.close();
        }

        // ===============================================================
        //  API CALLER & UPLOADER
        // ===============================================================
        async function callApi(endpoint, payload = {}, method = 'GET') {
            let url = API_BASE_URL + endpoint;
            const options = {
                method,
                headers: { 'Content-Type': 'application/json' },
            };
            if (currentUser.lineUserId) {
                 options.headers['X-Admin-User-ID'] = currentUser.lineUserId;
            }

            if (method.toUpperCase() === 'GET' && Object.keys(payload).length > 0) {
                const params = new URLSearchParams(payload).toString();
                url += '?' + params;
            } else if (method.toUpperCase() !== 'GET') {
                options.body = JSON.stringify(payload);
            }

            try {
                const response = await fetch(url, options);
                if (!response.ok) {
                    const errorResult = await response.json().catch(() => ({ message: 'API request failed with status ' + response.status }));
                    throw new Error(errorResult.message);
                }
                const result = await response.json();
                if (result.status === 'error') {
                    throw new Error(result.message);
                }
                return result.data;
            } catch (error) {
                console.error(`API Error at ${endpoint}:`, error);
                throw error;
            }
        }

        async function uploadImage(file) {
            const formData = new FormData();
            formData.append('image', file);
            try {
                const response = await fetch(`${API_BASE_URL}/api/upload`, {
                    method: 'POST',
                    body: formData,
                });
                 if (!response.ok) {
                    const errorResult = await response.json().catch(() => ({ message: 'Image upload failed with status ' + response.status }));
                    throw new Error(errorResult.message);
                }
                const result = await response.json();
                if (result.status === 'success') {
                    return result.data.imageUrl;
                } else {
                    throw new Error(result.message || 'Failed to get image URL from server.');
                }
            } catch (error) {
                console.error('Image Upload Error:', error);
                throw new Error('‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
            }
        }
        
        // ===============================================================
        //  UI RENDERING FUNCTIONS
        // ===============================================================
        /**
         * ü™Ñ ‡∏Ñ‡∏≤‡∏ñ‡∏≤‡∏ß‡∏¥‡πÄ‡∏®‡∏©: ‡πÅ‡∏õ‡∏•‡∏á URL ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á
         * ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö path ‡∏Ç‡∏≠‡∏á‡∏£‡∏π‡∏õ ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô path ‡∏™‡∏±‡πâ‡∏ô‡πÜ (‡∏Ç‡∏∂‡πâ‡∏ô‡∏ï‡πâ‡∏ô‡∏î‡πâ‡∏ß‡∏¢ /)
         * ‡∏°‡∏±‡∏ô‡∏à‡∏∞‡πÄ‡∏≠‡∏≤ URL ‡∏Ç‡∏≠‡∏á Backend ‡∏°‡∏≤‡πÅ‡∏õ‡∏∞‡∏Ç‡πâ‡∏≤‡∏á‡∏´‡∏ô‡πâ‡∏≤‡πÉ‡∏´‡πâ‡πÄ‡∏≠‡∏á
         */
        function getFullImageUrl(path) {
            const placeholder = 'https://placehold.co/600x300/e9ecef/6c757d?text=Image';
            if (!path) {
                return placeholder;
            }
            // Check if the path is already a full URL
            if (path.startsWith('http://') || path.startsWith('https://')) {
                return path;
            }
            // If it's a relative path, prepend the backend URL with the /uploads prefix
            return `${API_BASE_URL}/uploads/${path}`;
        }

        function updateUserInfoUI(user) {
            $('#user-profile-pic, #profile-page-pic').attr('src', user.pictureUrl || 'https://placehold.co/80x80');
            $('#user-display-name, #profile-page-name').text(user.fullName);
            $('#user-employee-id').text(`‡∏£‡∏´‡∏±‡∏™: ${user.employeeId}`);
            $('#profile-page-employee-id').text(`‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô: ${user.employeeId}`);
            $('#user-score, #profile-page-score').text(user.totalScore);
        }

        function displayActivitiesUI(activities, listId) {
            const listElement = $(`#${listId}`);
            listElement.empty();
            if (!activities || activities.length === 0) {
                listElement.html('<p class="text-center text-muted">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡πÉ‡∏ô‡∏Ç‡∏ì‡∏∞‡∏ô‡∏µ‡πâ</p>');
                return;
            }
            activities.forEach(act => {
                const cardHtml = `
                    <div class="card shadow-sm mb-3">
                        <img src="${getFullImageUrl(act.imageUrl)}" class="card-img-top" style="height:150px;object-fit:cover;" onerror="this.onerror=null;this.src='https://placehold.co/600x300/e9ecef/6c757d?text=Image';">
                        <div class="card-body">
                            <h5 class="card-title fw-bold">${sanitizeHTML(act.title)}</h5>
                            <p class="card-text text-muted small">${sanitizeHTML(act.description)}</p>
                            <div class="d-flex justify-content-between gap-2 mt-3">
                                <button class="btn btn-outline-primary btn-view-report w-50 py-2" data-activity-id="${act.activityId}" data-activity-title="${sanitizeHTML(act.title)}">
                                    <i class="fas fa-eye me-1"></i> ‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô
                                </button>
                                <button class="btn btn-primary btn-join-activity w-50 py-2" data-activity-id="${act.activityId}" data-activity-title="${sanitizeHTML(act.title)}">
                                    <i class="fas fa-plus-circle me-1"></i> ‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°
                                </button>
                            </div>
                        </div>
                    </div>`;
                listElement.append(cardHtml);
            });
        }
        
        function renderSubmissions(submissions) {
            const container = $('#submissions-container');
            container.empty();
            if (submissions.length === 0) { 
                container.html('<p class="text-center text-muted mt-5">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏Ñ‡∏£‡∏™‡πà‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏ô‡∏µ‡πâ<br>‡∏°‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡∏ô‡πÅ‡∏£‡∏Å‡∏Å‡∏±‡∏ô‡πÄ‡∏ñ‡∏≠‡∏∞!</p>'); 
                return; 
            }
            submissions.forEach(sub => {
                const likedClass = sub.didLike ? 'liked' : '';
                let commentsHtml = sub.comments.map(c => `
                    <div class="comment-item p-2 rounded mb-2 d-flex">
                        <img src="${c.commenter.pictureUrl || 'https://placehold.co/24x24'}" class="rounded-circle me-2" width="24" height="24" onerror="this.onerror=null;this.src='https://placehold.co/24x24';">
                        <div><strong>${sanitizeHTML(c.commenter.fullName)}:</strong> ${sanitizeHTML(c.commentText)}</div>
                    </div>`).join('');
                
                const imageHtml = sub.imageUrl ? `<img src="${sub.imageUrl}" class="card-img-top mb-3" alt="Submission Image">` : '';

                const card = `
                    <div class="card submission-card shadow-sm mb-3">
                        ${imageHtml}
                        <div class="card-body">
                            <div class="d-flex align-items-center mb-2">
                                <img src="${sub.submitter.pictureUrl || 'https://placehold.co/40x40'}" class="rounded-circle me-2" width="40" height="40" onerror="this.onerror=null;this.src='https://placehold.co/40x40';">
                                <div>
                                    <h6 class="mb-0">${sanitizeHTML(sub.submitter.fullName)}</h6>
                                    <small class="text-muted">${new Date(sub.createdAt).toLocaleString()}</small>
                                </div>
                            </div>
                            <p class="card-text">${sanitizeHTML(sub.description)}</p>
                            ${sub.points > 0 ? `<div class="text-end fw-bold text-primary">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö: ${sub.points}</div>` : '<div class="text-end text-muted small">‡∏£‡∏≠ Admin ‡πÉ‡∏´‡πâ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</div>'}
                        </div>
                        <div class="card-footer bg-white d-flex justify-content-start align-items-center gap-3">
                            <button class="btn btn-sm btn-link text-decoration-none like-btn ${likedClass}" data-submission-id="${sub.submissionId}">
                                <i class="fas fa-heart"></i> <span class="like-count">${sub.likes}</span>
                            </button>
                            <div class="text-muted"><i class="fas fa-comment"></i> ${sub.comments.length}</div>
                            ${currentUser.isAdmin ? `<button class="btn btn-sm btn-danger ms-auto btn-delete-submission" data-id="${sub.submissionId}"><i class="fas fa-trash-alt"></i> ‡∏•‡∏ö</button>` : ''}
                        </div>
                        <div class="card-footer bg-white">
                            <div class="comment-list mb-2">${commentsHtml}</div>
                            <form class="d-flex comment-form" data-submission-id="${sub.submissionId}">
                                <input type="text" class="form-control form-control-sm comment-input" placeholder="‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô...">
                                <button type="submit" class="btn btn-primary btn-sm ms-2">‡∏™‡πà‡∏á</button>
                            </form>
                        </div>
                    </div>`;
                container.append(card);
            });
        }

        function renderAdminChart(chartData) {
            const ctx = document.getElementById('reportsChart').getContext('2d');
            if(reportsChart) {
                reportsChart.destroy();
            }
            reportsChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: chartData.labels,
                    datasets: [{
                        label: '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô',
                        data: chartData.data,
                        backgroundColor: 'rgba(54, 162, 235, 0.6)',
                        borderColor: 'rgba(54, 162, 235, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: { display: true, text: '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô 7 ‡∏ß‡∏±‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î' }
                    },
                    scales: {
                        y: { beginAtZero: true, ticks: { stepSize: 1 } }
                    }
                }
            });
        }
        
        // ===============================================================
        //  DATA LOADING FUNCTIONS
        // ===============================================================
        async function loadAndShowActivityDetails(activityId, activityTitle) {
            $('#activity-detail-title').text(activityTitle);
            const container = $('#submissions-container');
            $('#submissions-loading').show();
            container.empty();
            allModals['activity-detail'].show();
            
            // Remove 'btn-join-activity' from the modal footer
            $('.modal-footer .btn-join-activity').remove();
            
            try {
                const submissions = await callApi('/api/submissions', { activityId, lineUserId: lineProfile.userId });
                renderSubmissions(submissions);
            } catch (error) { 
                container.html('<p class="text-center text-danger">‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ</p>'); 
            } finally { 
                $('#submissions-loading').hide(); 
            }
        }
        
        async function loadLeaderboard() {
            const list = $('#leaderboard-list');
            const loading = $('#leaderboard-loading');
            list.empty();
            loading.show();
            try {
                const users = await callApi('/api/leaderboard');
                loading.hide();
                users.forEach((user, index) => {
                    const rank = index + 1;
                    let rankDisplay = rank;
                    if (rank === 1) rankDisplay = '<i class="fas fa-trophy"></i>';
                    else if (rank === 2) rankDisplay = '<i class="fas fa-medal text-secondary"></i>';
                    else if (rank === 3) rankDisplay = '<i class="fas fa-medal" style="color:#cd7f32;"></i>';

                    const itemHtml = `
                        <div class="d-flex align-items-center p-2 mb-2 bg-white rounded-3 shadow-sm leaderboard-item">
                            <div class="leaderboard-rank me-3">${rankDisplay}</div>
                            <img src="${user.pictureUrl}" class="rounded-circle me-3" width="45" height="45" onerror="this.onerror=null;this.src='https://placehold.co/45x45';">
                            <div class="flex-grow-1">
                                <div class="fw-bold">${sanitizeHTML(user.fullName)}</div>
                            </div>
                            <div class="fw-bold text-primary">${user.totalScore} ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</div>
                        </div>`;
                    list.append(itemHtml);
                });
            } catch (error) {
                loading.hide();
                list.html('<p class="text-center text-danger">‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ</p>');
            }
        }

        async function loadUserBadges() {
            const container = $('#badges-container');
            const progressBar = $('#progress-bar');
            const progressText = $('#progress-text');
            container.html('<div class="spinner-border"></div>');
            try {
                const badges = await callApi('/api/user/badges', { lineUserId: lineProfile.userId });
                container.empty();
                if (badges.length === 0) {
                    container.html('<p class="text-muted">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡πâ‡∏≤‡∏¢‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•</p>');
                } else {
                    badges.forEach(b => {
                        const lockClass = b.isEarned ? '' : 'locked';
                        const html = `
                            <div class="text-center" title="${sanitizeHTML(b.name)}: ${sanitizeHTML(b.desc)}">
                                <img src="${getFullImageUrl(b.img)}" class="badge-icon ${lockClass}" onerror="this.onerror=null;this.src='https://placehold.co/60x60/e9ecef/6c757d?text=Badge';">
                                <div class="small">${sanitizeHTML(b.name)}</div>
                            </div>`;
                        container.append(html);
                    });
                }
                
                // Update Progress Bar
                const earnedBadges = badges.filter(b => b.isEarned).length;
                const totalBadges = badges.length;
                const progress = totalBadges > 0 ? (earnedBadges / totalBadges) * 100 : 0;
                progressBar.css('width', progress + '%').attr('aria-valuenow', progress).text(Math.round(progress) + '%');
                progressText.text(`‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö ${earnedBadges} ‡∏à‡∏≤‡∏Å ${totalBadges} ‡∏õ‡πâ‡∏≤‡∏¢‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î`);

            } catch (e) {
                container.html('<p class="text-danger">‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏õ‡πâ‡∏≤‡∏¢‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡πÑ‡∏î‡πâ</p>');
            }
        }

        // ===============================================================
        //  EVENT LISTENERS
        // ===============================================================
        function bindStaticEventListeners() {
            // --- Navigation ---
            $('.nav-link').on('click', function(e) {
                e.preventDefault();
                const pageId = $(this).data('page');
                if (pageId) {
                    $('.nav-link').removeClass('active');
                    $(this).addClass('active');
                    $('.page').removeClass('active');
                    $('#' + pageId).addClass('active');

                    if (pageId === 'leaderboard-page') loadLeaderboard();
                    if (pageId === 'profile-page') loadUserBadges();
                }
            });

            // --- Forms ---
            $('#registration-form').on('submit', handleRegistration);
            $('#submission-form').on('submit', handleSubmitReport);
            $('#activity-form').on('submit', handleSaveActivity);
            $('#badge-form').on('submit', handleSaveBadge);

            // --- Dynamic Buttons ---
            $(document).on('click', '.btn-view-report', handleViewReport);
            $(document).on('click', '.btn-join-activity', handleJoinActivity);
            $(document).on('click', '.like-btn', handleLike);
            $(document).on('submit', '.comment-form', handleComment);
            
            // --- Buttons in modals ---
            $('#add-badge-btn').on('click', handleAddBadge);
            $(document).on('click', '.btn-delete-submission', handleDeleteSubmission);

            // Image Previews
            $('#image-input').on('change', function() { handleImagePreview(this, '#submission-image-preview'); });
            $('#form-activity-image-input').on('change', function() { handleImagePreview(this, '#activity-image-preview'); });
            $('#badge-image-input').on('change', function() { handleImagePreview(this, '#badge-image-preview'); });

        }

        function bindAdminEventListeners() {
            $('#view-stats-btn').on('click', handleViewStats);
            $('#manage-reports-btn').on('click', handleManageReports);
            $('#manage-activities-btn').on('click', handleManageActivities);
            $('#manage-badges-btn').on('click', handleManageBadges);
            $('#create-activity-btn').on('click', handleCreateActivity);
            $(document).on('click', '.btn-approve, .btn-reject', handleApprovalAction);
            $(document).on('click', '.btn-edit-activity', handleEditActivity);
            $(document).on('click', '.btn-toggle-activity', handleToggleActivity);
            $(document).on('click', '.delete-badge-btn', handleDeleteBadge);
            $(document).on('click', '.award-badge-btn', handleAwardBadge);
            $(document).on('click', '.btn-edit-badge', handleEditBadge);
            $(document).on('click', '.btn-delete-activity', handleDeleteActivity);
            
        }

        function bindAdminTabEventListeners() {
            $('.admin-tab-btn').on('click', function(e) {
                e.preventDefault();
                $('.admin-tab-btn').removeClass('active');
                $(this).addClass('active');
                $('.admin-tab-content').hide();
                const tab = $(this).data('tab');
                $('#' + tab + 'Tab').show();
                if (tab === 'manageBadges') {
                    loadBadgesForAdmin();
                } else if (tab === 'manageUsers') {
                    loadUsersForAdmin();
                }
            });
            $('#user-search-input').on('input', function() {
                const query = $(this).val();
                if (query.length > 2) {
                    searchUsersForAdmin(query);
                } else if (query.length === 0) {
                    loadUsersForAdmin(); // Load all users if search box is empty
                }
            });
        }

        // ===============================================================
        //  EVENT HANDLER FUNCTIONS
        // ===============================================================
        async function handleRegistration(e) {
            e.preventDefault();
            const fullName = $('#fullName').val().trim();
            const employeeId = $('#employeeId').val().trim();
            showLoading('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...');
            try {
                const newUser = await callApi("/api/user/register", {
                    lineUserId: lineProfile.userId,
                    displayName: lineProfile.displayName,
                    pictureUrl: lineProfile.pictureUrl,
                    fullName: fullName,
                    employeeId: employeeId
                }, 'POST');
                $('#registration-page').hide();
                await showMainApp(newUser);
                showSuccess('‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!');
            } catch (error) {
                showError(error.message);
            }
        }
        
        async function handleSubmitReport(e) {
            e.preventDefault();
            const imageFile = $('#image-input')[0].files[0];
            const description = $('#description-input').val().trim();
            
            // Allow submission without an image
            if (!description) {
                return showWarning('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏à‡∏∏‡∏î‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á');
            }
            
            showLoading('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏•‡∏∞‡∏™‡πà‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô...');
            try {
                let imageUrl = null;
                if (imageFile) {
                    imageUrl = await uploadImage(imageFile);
                }

                const payload = {
                    lineUserId: lineProfile.userId,
                    activityId: $('#activityId-input').val(),
                    description: description,
                    imageUrl: imageUrl
                };
                
                await callApi('/api/submissions', payload, 'POST');
                allModals.submission.hide();
                $('#submission-form')[0].reset();
                $('#submission-image-preview').attr('src', 'https://placehold.co/400x300/e9ecef/6c757d?text=Preview');
                showSuccess('‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ñ‡∏π‡∏Å‡∏™‡πà‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö');
                
            } catch (error) {
                showError(error.message);
            }
        }
        
        function handleViewReport() {
            const activityId = $(this).data('activity-id');
            const activityTitle = $(this).data('activity-title');
            loadAndShowActivityDetails(activityId, activityTitle);
        }

        function handleJoinActivity() {
            const activityId = $(this).data('activity-id');
            const activityTitle = $(this).data('activity-title');
            $('#activityId-input').val(activityId);
            $('#activity-title-modal').text(activityTitle);
            allModals['submission'].show();
        }

        async function handleLike() {
            const btn = $(this);
            const submissionId = btn.data('submission-id');
            btn.prop('disabled', true);
            try {
                const result = await callApi('/api/submissions/like', { submissionId, lineUserId: lineProfile.userId }, 'POST');
                const countSpan = btn.find('.like-count');
                countSpan.text(result.newLikeCount);
                btn.toggleClass('liked', result.status === 'liked');
            } catch (error) {
                console.error("Like failed:", error);
            } finally {
                btn.prop('disabled', false);
            }
        }

        async function handleComment(e) {
            e.preventDefault();
            const form = $(this);
            const submissionId = form.data('submission-id');
            const input = form.find('.comment-input');
            const commentText = input.val().trim();
            if(!commentText) return;
            
            const submitBtn = form.find('button');
            submitBtn.prop('disabled', true);
            
            try {
                await callApi('/api/submissions/comment', { submissionId, lineUserId: lineProfile.userId, commentText }, 'POST');
                const activityId = $('.btn-join-from-detail').data('activity-id');
                const submissions = await callApi('/api/submissions', { activityId, lineUserId: lineProfile.userId });
                renderSubmissions(submissions);

            } catch (e) { 
                showError('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô‡πÑ‡∏î‡πâ'); 
            } finally {
                submitBtn.prop('disabled', false); 
            }
        }

        function handleImagePreview(input, previewSelector) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    $(previewSelector).attr('src', e.target.result);
                }
                reader.readAsDataURL(input.files[0]);
            }
        }
        
        // --- Admin Handlers ---
        function handleViewStats() { loadAdminStats(); allModals['admin-stats'].show(); }
        function handleManageReports() { loadPendingSubmissions(); allModals['admin-reports'].show(); }
        function handleManageActivities() { loadAllActivitiesForAdmin(); allModals['admin-activities'].show(); }
        
        function handleCreateActivity() {
            $('#activity-form-title').text('‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡πÉ‡∏´‡∏°‡πà');
            $('#activity-form')[0].reset();
            $('#form-activity-id').val('');
            $('#activity-image-preview').attr('src', 'https://placehold.co/400x300/e9ecef/6c757d?text=Preview');
            allModals['activity-form'].show();
        }

        async function handleSaveActivity(e) {
            e.preventDefault();
            showLoading('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...');
            const imageFile = $('#form-activity-image-input')[0].files[0];
            const existingImageUrl = $('#form-activity-image-url').val();
            
            try {
                let finalImageUrl = existingImageUrl;
                if (imageFile) {
                    finalImageUrl = await uploadImage(imageFile);
                }

                const payload = {
                    activityId: $('#form-activity-id').val(),
                    title: $('#form-activity-title').val(),
                    description: $('#form-activity-desc').val(),
                    imageUrl: finalImageUrl
                };

                const isUpdate = !!payload.activityId;
                const method = isUpdate ? 'PUT' : 'POST';
                await callApi('/api/admin/activities', payload, method);
                
                allModals['activity-form'].hide();
                showSuccess('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');
                loadAllActivitiesForAdmin();
                const activities = await callApi('/api/activities');
                displayActivitiesUI(activities, 'latest-activities-list');
                displayActivitiesUI(activities, 'all-activities-list');
            } catch (e) {
                showError(e.message);
            }
        }
        
        async function handleDeleteActivity() {
            const activityId = $(this).data('id');
            if (confirm('‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏ô‡∏µ‡πâ? ‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏ó‡∏≥‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏î‡πâ')) {
                showLoading('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏•‡∏ö‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°...');
                try {
                    await callApi(`/api/admin/activities/${activityId}`, { adminUserId: currentUser.lineUserId }, 'DELETE');
                    showSuccess('‡∏•‡∏ö‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');
                    loadAllActivitiesForAdmin();
                    const activities = await callApi('/api/activities');
                    displayActivitiesUI(activities, 'latest-activities-list');
                    displayActivitiesUI(activities, 'all-activities-list');
                } catch (e) {
                    showError(e.message);
                }
            }
        }

        async function handleApprovalAction() {
            const btn = $(this);
            const action = btn.hasClass('btn-approve') ? 'approve' : 'reject';
            const id = btn.data('id');
            const score = $(`#score-input-${id}`).val();
            const row = $(`#row-${id}`);
            row.css('opacity', '0.5');
            btn.prop('disabled', true).parent().find('button').prop('disabled', true);
            try {
                if (action === 'approve') {
                    await callApi(`/api/admin/submissions/approve`, { submissionId: id, adminUserId: currentUser.lineUserId, score: score }, 'POST');
                } else {
                    await callApi(`/api/admin/submissions/reject`, { submissionId: id, adminUserId: currentUser.lineUserId }, 'POST');
                }
                row.fadeOut(500, function() { $(this).remove(); });
            } catch (e) {
                showError('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î');
                row.css('opacity', '1');
                btn.prop('disabled', false).parent().find('button').prop('disabled', false);
            }
        }
        
        async function handleEditActivity() {
            const data = JSON.parse(decodeURIComponent($(this).data('activity-data')));
            $('#activity-form-title').text('‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°');
            $('#activity-form')[0].reset();
            $('#form-activity-id').val(data.activityId);
            $('#form-activity-title').val(data.title);
            $('#form-activity-desc').val(data.description);
            $('#form-activity-image-url').val(data.imageUrl); // Store existing URL
            $('#activity-image-preview').attr('src', getFullImageUrl(data.imageUrl));
            allModals['activity-form'].show();
        }

        async function handleToggleActivity() {
            const btn = $(this);
            const id = btn.data('id');
            btn.prop('disabled', true);
            try {
                await callApi('/api/admin/activities/toggle', { activityId: id, adminUserId: currentUser.lineUserId }, 'POST');
                loadAllActivitiesForAdmin();
            } catch (e) {
                console.error("Toggle failed:", e);
                btn.prop('disabled', false);
            }
        }

        async function handleDeleteSubmission() {
            const submissionId = $(this).data('id');
            if (confirm('‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ô‡∏µ‡πâ?')) {
                showLoading('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô...');
                try {
                    await callApi(`/api/admin/submissions/${submissionId}`, { adminUserId: currentUser.lineUserId }, 'DELETE');
                    showSuccess('‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');
                    
                    const activityId = $('.btn-join-from-detail').data('activity-id');
                    const activityTitle = $('#activity-detail-title').text();
                    loadAndShowActivityDetails(activityId, activityTitle);
                } catch (e) {
                    showError(e.message);
                }
            }
        }
        
        // --- NEW ADMIN FUNCTIONS ---
        function handleManageBadges() {
            allModals['admin-manage-badges'].show();
            loadBadgesForAdmin();
        }

        function handleAddBadge() {
            $('#badge-form-title').text('‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏õ‡πâ‡∏≤‡∏¢‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡πÉ‡∏´‡∏°‡πà');
            $('#badge-form')[0].reset();
            $('#badge-image-preview').attr('src', 'https://placehold.co/400x300/e9ecef/6c757d?text=Preview');
            allModals['badge-form'].show();
        }

        async function handleSaveBadge(e) {
            e.preventDefault();
            showLoading('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...');
            const imageFile = $('#badge-image-input')[0].files[0];
            const payload = {
                badgeName: $('#badge-name-input').val(),
                description: $('#badge-desc-input').val(),
                badgeId: $('#badge-id-input').val()
            };
            
            try {
                let finalImageUrl = null;
                if (imageFile) {
                    finalImageUrl = await uploadImage(imageFile);
                } else {
                    finalImageUrl = $('#badge-image-url-input').val(); // Use existing URL if no new file
                }
                payload.imageUrl = finalImageUrl;

                const method = payload.badgeId ? 'PUT' : 'POST';
                const url = payload.badgeId ? `/api/admin/badges/${payload.badgeId}` : '/api/admin/badges';
                await callApi(url, payload, method);
                
                allModals['badge-form'].hide();
                showSuccess('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏õ‡πâ‡∏≤‡∏¢‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');
                loadBadgesForAdmin();
            } catch (e) {
                showError(e.message);
            }
        }

        async function handleDeleteBadge() {
            const badgeId = $(this).data('badge-id');
            if (confirm('‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏õ‡πâ‡∏≤‡∏¢‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡∏ô‡∏µ‡πâ?')) {
                showLoading('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏•‡∏ö...');
                try {
                    await callApi(`/api/admin/badges/${badgeId}`, { adminUserId: currentUser.lineUserId }, 'DELETE');
                    showSuccess('‡∏•‡∏ö‡∏õ‡πâ‡∏≤‡∏¢‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');
                    loadBadgesForAdmin();
                } catch (e) {
                    showError(e.message);
                }
            }
        }

        function handleEditBadge() {
            const badgeId = $(this).data('badge-id');
            const badgeName = $(this).data('badge-name');
            const badgeDesc = $(this).data('badge-desc');
            const badgeUrl = $(this).data('badge-url');

            $('#badge-form-title').text('‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏õ‡πâ‡∏≤‡∏¢‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•');
            $('#badge-form')[0].reset();
            $('#badge-id-input').val(badgeId);
            $('#badge-name-input').val(badgeName);
            $('#badge-desc-input').val(badgeDesc);
            $('#badge-image-url-input').val(badgeUrl);
            $('#badge-image-preview').attr('src', badgeUrl);

            allModals['badge-form'].show();
        }

        async function handleAwardBadge() {
            const btn = $(this);
            const userId = btn.data('user-id');
            const badgeId = btn.data('badge-id');
            showLoading('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏°‡∏≠‡∏ö‡∏õ‡πâ‡∏≤‡∏¢‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•...');
            btn.prop('disabled', true);
            try {
                await callApi('/api/admin/award-badge', { lineUserId: userId, badgeId: badgeId, adminUserId: currentUser.lineUserId }, 'POST');
                btn.text('‡∏°‡∏≠‡∏ö‡πÅ‡∏•‡πâ‡∏ß').addClass('btn-success').removeClass('btn-outline-primary').prop('disabled', true);
                showSuccess('‡∏°‡∏≠‡∏ö‡∏õ‡πâ‡∏≤‡∏¢‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');
            } catch (e) {
                showError(e.message);
                btn.prop('disabled', false);
            }
        }

        // ===============================================================
        //  ADMIN DATA LOADING
        // ===============================================================
        async function loadAdminStats() {
            const container = $('#stats-container');
            $('#stats-loading').show();
            container.empty();
            try {
                const [stats, chartData] = await Promise.all([
                    callApi('/api/admin/stats'),
                    callApi('/api/admin/chart-data')
                ]);

                renderAdminChart(chartData);

                const statsHtml = `
                    <div class="col-md-6"><div class="card stat-card shadow-sm"><div class="card-body"><h6 class="card-subtitle mb-2 text-muted">‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h6><h4 class="card-title">${stats.totalUsers} ‡∏Ñ‡∏ô</h4></div></div></div>
                    <div class="col-md-6"><div class="card stat-card shadow-sm"><div class="card-body"><h6 class="card-subtitle mb-2 text-muted">‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h6><h4 class="card-title">${stats.totalSubmissions} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</h4></div></div></div>
                    <div class="col-md-6"><div class="card stat-card shadow-sm"><div class="card-body"><h6 class="card-subtitle mb-2 text-muted">‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</h6><h4 class="card-title">${stats.submissionsToday} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</h4></div></div></div>
                    <div class="col-md-6"><div class="card stat-card shadow-sm"><div class="card-body"><h6 class="card-subtitle mb-2 text-muted">‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏°‡∏≤‡∏Å‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î</h6><h5 class="card-title small">${sanitizeHTML(stats.mostReportedActivity)}</h5></div></div></div>`;
                container.html(statsHtml);
            } catch(e) { 
                container.html('<p class="text-center text-danger">‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏£‡∏∏‡∏õ‡πÑ‡∏î‡πâ</p>'); 
            } finally { 
                $('#stats-loading').hide(); 
            }
        }

        async function loadPendingSubmissions() {
            const tableBody = $('#submissions-table-body');
            $('#reports-loading').show();
            $('#no-reports-message').hide();
            tableBody.empty();
            try {
                const subs = await callApi('/api/admin/submissions/pending');
                $('#pending-count-modal').text(subs.length);
                if (subs.length === 0) {
                    $('#no-reports-message').show();
                } else {
                    subs.forEach(s => {
                        const imageUrl = s.imageUrl ? `<a href="${s.imageUrl}" target="_blank">‡∏î‡∏π‡∏£‡∏π‡∏õ</a>` : '‡πÑ‡∏°‡πà‡∏°‡∏µ';
                        const row = `
                            <tr id="row-${s.submissionId}">
                                <td><div class="fw-bold">${sanitizeHTML(s.submitter.fullName)}</div><small class="text-muted">${new Date(s.createdAt).toLocaleString()}</small></td>
                                <td>${sanitizeHTML(s.description)}</td>
                                <td>${imageUrl}</td>
                                <td>
                                    <div class="d-flex align-items-center">
                                        <input type="number" id="score-input-${s.submissionId}" class="form-control form-control-sm me-2" value="10" min="0" style="width: 70px;">
                                        <button class="btn btn-success btn-sm btn-approve" data-id="${s.submissionId}">‚úì</button>
                                        <button class="btn btn-danger btn-sm btn-reject ms-1" data-id="${s.submissionId}">‚úó</button>
                                    </div>
                                </td>
                            </tr>`;
                        tableBody.append(row);
                    });
                }
            } finally {
                $('#reports-loading').hide();
            }
        }

        async function loadAllActivitiesForAdmin() {
            const list = $('#activities-list-admin');
            list.html('<div class="spinner-border"></div>');
            try {
                const acts = await callApi('/api/admin/activities');
                list.empty();
                acts.forEach(a => {
                    const statusBadge = a.status === 'active' ? 'bg-success' : 'bg-secondary';
                    const btnText = a.status === 'active' ? 'Deactivate' : 'Activate';
                    const btnClass = a.status === 'active' ? 'btn-secondary' : 'btn-success';
                    const activityData = encodeURIComponent(JSON.stringify(a));
                    const html = `
                        <div class="card mb-2"><div class="card-body d-flex align-items-center">
                            <div><span class="badge ${statusBadge} me-2">${a.status}</span><strong>${sanitizeHTML(a.title)}</strong></div>
                            <div class="ms-auto">
                                <button class="btn btn-sm btn-primary btn-edit-activity me-1" data-activity-data='${activityData}'><i class="fas fa-edit"></i></button>
                                <button class="btn btn-sm ${btnClass} btn-toggle-activity me-1" data-id="${a.activityId}">${btnText}</button>
                                <button class="btn btn-sm btn-danger btn-delete-activity" data-id="${a.activityId}"><i class="fas fa-trash-alt"></i></button>
                            </div>
                        </div></div>`;
                    list.append(html);
                });
            } catch(e) {
                list.html('<p class="text-danger">‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡πÑ‡∏î‡πâ</p>');
            }
        }

        async function loadBadgesForAdmin() {
            const list = $('#badges-list');
            list.html('<div class="text-center"><div class="spinner-border"></div></div>');
            try {
                const badges = await callApi('/api/admin/badges');
                list.empty();
                if (badges.length === 0) {
                    list.html('<p class="text-center text-muted">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡πâ‡∏≤‡∏¢‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•</p>');
                } else {
                    badges.forEach(b => {
                        const html = `
                            <div class="col-md-4 mb-3">
                                <div class="card text-center shadow-sm">
                                    <div class="card-body">
                                        <img src="${b.imageUrl}" class="mb-2" style="width: 80px; height: 80px;">
                                        <h5 class="card-title fw-bold">${sanitizeHTML(b.badgeName)}</h5>
                                        <p class="card-text small text-muted">${sanitizeHTML(b.description)}</p>
                                        <div class="d-flex justify-content-center">
                                            <button class="btn btn-sm btn-primary me-2 btn-edit-badge" data-badge-id="${b.badgeId}" data-badge-name="${sanitizeHTML(b.badgeName)}" data-badge-desc="${sanitizeHTML(b.description)}" data-badge-url="${b.imageUrl}"><i class="fas fa-edit me-1"></i> ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
                                            <button class="btn btn-sm btn-danger delete-badge-btn" data-badge-id="${b.badgeId}"><i class="fas fa-trash-alt me-1"></i> ‡∏•‡∏ö</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                        list.append(html);
                    });
                }
            } catch (e) {
                list.html('<p class="text-danger text-center">‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏õ‡πâ‡∏≤‡∏¢‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡πÑ‡∏î‡πâ</p>');
            }
        }

        async function loadUsersForAdmin() {
            const resultsDiv = $('#user-search-results');
            resultsDiv.html('<div class="text-center"><div class="spinner-border"></div></div>');
            try {
                const users = await callApi('/api/admin/users');
                resultsDiv.empty();
                if (users.length === 0) {
                    resultsDiv.html('<p class="text-center text-muted">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</p>');
                } else {
                    const allBadges = await callApi('/api/admin/badges');
                    const allBadgesMap = new Map(allBadges.map(b => [b.badgeId, b]));

                    for (const u of users) {
                        const userBadges = await callApi(`/api/admin/user-details/${u.lineUserId}`);
                        const userEarnedIds = new Set(userBadges.earnedBadgeIds);
                        
                        let badgeButtonsHtml = '';
                        allBadgesMap.forEach((badge, badgeId) => {
                            if (!userEarnedIds.has(badgeId)) {
                                badgeButtonsHtml += `<button class="btn btn-sm btn-outline-primary award-badge-btn me-2 mb-2" data-user-id="${u.lineUserId}" data-badge-id="${badgeId}">${sanitizeHTML(badge.badgeName)}</button>`;
                            }
                        });
                        
                        if (badgeButtonsHtml === '') {
                            badgeButtonsHtml = '<p class="text-muted small">‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ô‡∏µ‡πâ‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏õ‡πâ‡∏≤‡∏¢‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡∏Ñ‡∏£‡∏ö‡∏ó‡∏∏‡∏Å‡∏õ‡πâ‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß</p>';
                        }

                        const html = `
                            <div class="card mb-2">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <div>
                                            <h6 class="fw-bold">${sanitizeHTML(u.fullName)}</h6>
                                            <p class="text-muted small mb-0">‡∏£‡∏´‡∏±‡∏™: ${sanitizeHTML(u.employeeId)}</p>
                                        </div>
                                        <div class="text-end">
                                            <h5 class="mb-0 fw-bold text-primary">${u.totalScore}</h5>
                                            <small class="text-muted">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</small>
                                        </div>
                                    </div>
                                    <hr class="my-2">
                                    <div class="mt-3">
                                        <h6 class="small fw-bold">‡∏°‡∏≠‡∏ö‡∏õ‡πâ‡∏≤‡∏¢‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•:</h6>
                                        ${badgeButtonsHtml}
                                    </div>
                                </div>
                            </div>
                        `;
                        resultsDiv.append(html);
                    }
                }
            } catch (e) {
                resultsDiv.html('<p class="text-danger text-center">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</p>');
            }
        }

        async function searchUsersForAdmin(query) {
            const resultsDiv = $('#user-search-results');
            resultsDiv.html('<div class="text-center"><div class="spinner-border"></div></div>');
            try {
                const users = await callApi('/api/admin/users', { search: query });
                resultsDiv.empty();
                if (users.length === 0) {
                    resultsDiv.html('<p class="text-center text-muted">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏Ñ‡∏≥‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</p>');
                } else {
                    const allBadges = await callApi('/api/admin/badges');
                    const allBadgesMap = new Map(allBadges.map(b => [b.badgeId, b]));

                    for (const u of users) {
                        const userBadges = await callApi(`/api/admin/user-details/${u.lineUserId}`);
                        const userEarnedIds = new Set(userBadges.earnedBadgeIds);
                        
                        let badgeButtonsHtml = '';
                        allBadgesMap.forEach((badge, badgeId) => {
                            if (!userEarnedIds.has(badgeId)) {
                                badgeButtonsHtml += `<button class="btn btn-sm btn-outline-primary award-badge-btn me-2 mb-2" data-user-id="${u.lineUserId}" data-badge-id="${badgeId}">${sanitizeHTML(badge.badgeName)}</button>`;
                            }
                        });
                        
                        if (badgeButtonsHtml === '') {
                            badgeButtonsHtml = '<p class="text-muted small">‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ô‡∏µ‡πâ‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏õ‡πâ‡∏≤‡∏¢‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡∏Ñ‡∏£‡∏ö‡∏ó‡∏∏‡∏Å‡∏õ‡πâ‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß</p>';
                        }

                        const html = `
                            <div class="card mb-2">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <div>
                                            <h6 class="fw-bold">${sanitizeHTML(u.fullName)}</h6>
                                            <p class="text-muted small mb-0">‡∏£‡∏´‡∏±‡∏™: ${sanitizeHTML(u.employeeId)}</p>
                                        </div>
                                        <div class="text-end">
                                            <h5 class="mb-0 fw-bold text-primary">${u.totalScore}</h5>
                                            <small class="text-muted">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</small>
                                        </div>
                                    </div>
                                    <hr class="my-2">
                                    <div class="mt-3">
                                        <h6 class="small fw-bold">‡∏°‡∏≠‡∏ö‡∏õ‡πâ‡∏≤‡∏¢‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•:</h6>
                                        ${badgeButtonsHtml}
                                    </div>
                                </div>
                            </div>
                        `;
                        resultsDiv.append(html);
                    }
                }
            } catch (e) {
                resultsDiv.html('<p class="text-danger text-center">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</p>');
            }
        }
        
        // ===============================================================
        //  UTILITY FUNCTIONS
        // ===============================================================
        function showLoading(title) { Swal.fire({ title: title, text: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà', allowOutsideClick: false, didOpen: () => Swal.showLoading() }); }
        function showSuccess(title) { Swal.fire('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', title, 'success'); }
        function showError(title) { Swal.fire('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', title, 'error'); }
        function showWarning(title) { Swal.fire('‡∏Ñ‡∏≥‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô', title, 'warning'); }
        function sanitizeHTML(str) {
            if (!str) return '';
            const temp = document.createElement('div');
            temp.textContent = str;
            return temp.innerHTML;
        }

    </script>
</body>
</html>